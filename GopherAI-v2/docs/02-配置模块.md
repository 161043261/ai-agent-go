# 配置模块 (config/)

## 1. 模块概述

配置模块负责加载和管理应用程序的所有配置项，使用 TOML 格式的配置文件，支持配置单例模式访问。

## 2. 文件结构

```
config/
├── config.go       # 配置结构定义与加载逻辑
└── config.toml     # TOML 格式配置文件
```

## 3. 配置结构体定义

### 3.1 主配置结构 (Config)

```go
type Config struct {
    RedisConfig    `toml:"redisConfig"`
    MysqlConfig    `toml:"mysqlConfig"`
    JwtConfig      `toml:"jwtConfig"`
    MainConfig     `toml:"mainConfig"`
    RagModelConfig `toml:"ragModelConfig"`
    ImageConfig    `toml:"imageConfig"`
}
```

### 3.2 主服务配置 (MainConfig)

```go
type MainConfig struct {
    Port    int    `toml:"port"`      // HTTP 服务端口
    AppName string `toml:"appName"`   // 应用名称
    Host    string `toml:"host"`      // 监听地址
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| Port | int | HTTP 服务监听端口 | 9090 |
| AppName | string | 应用程序名称 | "GopherAI" |
| Host | string | 服务绑定地址 | "0.0.0.0" |

### 3.3 Redis 配置 (RedisConfig)

```go
type RedisConfig struct {
    RedisEnabled  bool   `toml:"enabled"`   // 是否启用 Redis
    RedisPort     int    `toml:"port"`      // Redis 端口
    RedisDb       int    `toml:"db"`        // Redis 数据库索引
    RedisHost     string `toml:"host"`      // Redis 主机地址
    RedisPassword string `toml:"password"`  // Redis 密码
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| RedisEnabled | bool | 是否启用 Redis，若为 false 则使用 BigCache | true |
| RedisPort | int | Redis 服务端口 | 6379 |
| RedisDb | int | Redis 数据库索引 (0-15) | 0 |
| RedisHost | string | Redis 服务器地址 | "127.0.0.1" |
| RedisPassword | string | Redis 认证密码，为空则无密码 | "" |

### 3.4 MySQL 配置 (MysqlConfig)

```go
type MysqlConfig struct {
    MysqlPort         int    `toml:"port"`         // 端口
    MysqlHost         string `toml:"host"`         // 主机地址
    MysqlUser         string `toml:"user"`         // 用户名
    MysqlPassword     string `toml:"password"`     // 密码
    MysqlDatabaseName string `toml:"databaseName"` // 数据库名
    MysqlCharset      string `toml:"charset"`      // 字符集
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| MysqlPort | int | MySQL 端口 | 3306 |
| MysqlHost | string | MySQL 主机地址 | "127.0.0.1" |
| MysqlUser | string | 数据库用户名 | "root" |
| MysqlPassword | string | 数据库密码 | "123456" |
| MysqlDatabaseName | string | 数据库名称 | "GopherAI" |
| MysqlCharset | string | 字符编码 | "utf8mb4" |

### 3.5 JWT 配置 (JwtConfig)

```go
type JwtConfig struct {
    ExpireDuration int    `toml:"expire_duration"` // 过期时长(小时)
    Issuer         string `toml:"issuer"`          // 签发者
    Subject        string `toml:"subject"`         // 主题
    Key            string `toml:"key"`             // 签名密钥
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| ExpireDuration | int | Token 过期时长，单位：小时 | 8760 (1年) |
| Issuer | string | JWT 签发者标识 | "huanheart" |
| Subject | string | JWT 主题 | "GopherAI" |
| Key | string | JWT 签名密钥 | "GopherAI-v1" |

### 3.6 RAG 模型配置 (RagModelConfig)

```go
type RagModelConfig struct {
    RagEmbeddingModel string `toml:"embeddingModel"` // 向量嵌入模型
    RagChatModelName  string `toml:"chatModelName"`  // 聊天模型名称
    RagDocDir         string `toml:"docDir"`         // 文档存储目录
    RagBaseUrl        string `toml:"baseUrl"`        // API 基础 URL
    RagDimension      int    `toml:"dimension"`      // 向量维度
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| RagEmbeddingModel | string | 向量嵌入模型名称 | "text-embedding-v4" |
| RagChatModelName | string | 用于 RAG 的聊天模型 | "qwen-turbo" |
| RagDocDir | string | RAG 文档存储路径 | "./docs" |
| RagBaseUrl | string | API 服务地址 | "https://dashscope.aliyuncs.com/compatible-mode/v1" |
| RagDimension | int | 向量维度大小 | 1024 |

### 3.7 图像识别配置 (ImageConfig)

```go
type ImageConfig struct {
    Enabled        bool   `toml:"enabled"`        // 是否启用图像识别
    OnnxRuntimeLib string `toml:"onnxRuntimeLib"` // ONNX Runtime 库路径
    ModelPath      string `toml:"modelPath"`      // 模型文件路径
    LabelPath      string `toml:"labelPath"`      // 标签文件路径
}
```

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| Enabled | bool | 是否启用图像识别功能 | true |
| OnnxRuntimeLib | string | ONNX Runtime 动态库路径 | "../onnxruntime-win-x64-1.23.2/lib/onnxruntime.dll" |
| ModelPath | string | ONNX 模型文件路径 | "./models/mobilenetv2-7.onnx" |
| LabelPath | string | ImageNet 标签文件路径 | "./models/synset.txt" |

### 3.8 Redis 键配置 (RedisKeyConfig)

```go
type RedisKeyConfig struct {
    IndexName       string // 向量索引名称格式
    IndexNamePrefix string // 索引前缀格式
}
```

## 4. 核心函数

### 4.1 InitConfig()

初始化配置，从 `config.toml` 文件加载配置。

```go
func InitConfig() {
    cfg = new(Config)
    if _, err := toml.DecodeFile("config/config.toml", cfg); err != nil {
        log.Fatal("InitConfig failed: ", err)
    }
    log.Println("Config has been loaded")
}
```

**调用时机**: 应用启动时在 `main.go` 中调用

### 4.2 GetConfig()

获取配置单例。

```go
func GetConfig() *Config {
    return cfg
}
```

**返回值**: 配置对象指针

**使用示例**:
```go
cfg := config.GetConfig()
port := cfg.MainConfig.Port
dbHost := cfg.MysqlConfig.MysqlHost
```

## 5. 配置文件示例 (config.toml)

```toml
[mainConfig]
  appName = "GopherAI"
  host = "0.0.0.0"
  port = 9090

[redisConfig]
  enabled = true
  host = "127.0.0.1"
  port = 6379
  password = ""
  db = 0

[mysqlConfig]
  host = "127.0.0.1"
  port = 3306
  user = "root"
  password = "123456"
  databaseName = "GopherAI"
  charset = "utf8mb4"

[jwtConfig]
  expire_duration = 8760    # 过期时长：1年 (8760小时)
  issuer = "huanheart"
  subject = "GopherAI"
  key = "GopherAI-v1"

[ragModelConfig]
  embeddingModel = "text-embedding-v4"
  chatModelName = "qwen-turbo"
  docDir = "./docs"
  baseUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1"
  dimension = 1024

[imageConfig]
  enabled = true
  onnxRuntimeLib = "../onnxruntime-win-x64-1.23.2/lib/onnxruntime.dll"
  modelPath = "./models/mobilenetv2-7.onnx"
  labelPath = "./models/synset.txt"
```

## 6. 配置使用流程

```
┌────────────────────────────────────────────────────┐
│                     main.go                         │
│                        │                            │
│        config.InitConfig()  ◄── 启动时加载          │
│                        │                            │
└────────────────────────│────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────┐
│              config/config.toml                     │
│                        │                            │
│              TOML 解析到 Config 结构体               │
└────────────────────────│────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────┐
│              config.GetConfig()                     │
│                        │                            │
│         各模块通过单例获取配置                       │
│                        │                            │
│   ┌──────────┬─────────┼─────────┬──────────┐      │
│   ▼          ▼         ▼         ▼          ▼      │
│ MySQL     Redis     JWT      AIHelper   Image      │
└────────────────────────────────────────────────────┘
```

## 7. 依赖关系

- **被依赖模块**:
  - `main.go` - 初始化调用
  - `common/mysql` - MySQL 连接配置
  - `common/redis` - Redis 连接配置
  - `common/cache` - 缓存配置
  - `common/aihelper` - RAG 模型配置
  - `common/image` - 图像识别配置
  - `utils/myjwt` - JWT 配置
  - `middleware/jwt` - JWT 中间件配置

## 8. 注意事项

1. **配置文件路径**: 默认读取 `config/config.toml`，路径相对于程序运行目录
2. **敏感信息**: 生产环境中密码等敏感配置建议使用环境变量覆盖
3. **Redis 降级**: 若 `redisConfig.enabled = false`，系统会自动降级使用 BigCache 内存缓存
4. **图像识别**: 若 `imageConfig.enabled = false`，图像识别功能将被禁用
5. **路径配置**: 支持相对路径和绝对路径，相对路径基于程序运行目录
