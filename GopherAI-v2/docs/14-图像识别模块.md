# 图像识别模块 (common/image/)

## 1. 模块概述

图像识别模块基于 ONNX Runtime 实现，使用 MobileNetV2 模型进行 ImageNet 1000 类图像分类。

## 2. 文件结构

```
common/image/
└── image_recognizer.go    # ONNX 图像识别器
```

## 3. 核心结构体

```go
type ImageRecognizer struct {
    session      *ort.Session[float32]  // ONNX 会话
    inputName    string                  // 输入张量名
    outputName   string                  // 输出张量名
    inputH       int                     // 输入高度
    inputW       int                     // 输入宽度
    labels       []string                // 分类标签
    inputTensor  *ort.Tensor[float32]    // 输入张量
    outputTensor *ort.Tensor[float32]    // 输出张量
}
```

## 4. 主要函数

```go
// 创建识别器
func NewImageRecognizer(modelPath, labelPath string, inputH, inputW int) (*ImageRecognizer, error)

// 从文件识别
func (r *ImageRecognizer) PredictFromFile(imagePath string) (string, error)

// 从字节识别
func (r *ImageRecognizer) PredictFromBuffer(buf []byte) (string, error)

// 从图像对象识别
func (r *ImageRecognizer) PredictFromImage(img image.Image) (string, error)

// 释放资源
func (r *ImageRecognizer) Close() error
```

## 5. 处理流程

```
输入图像
    │
    ▼
解码图像 (JPEG/PNG/GIF)
    │
    ▼
缩放到 224x224
    │
    ▼
转换为 NCHW 格式
    │
    ├── N: Batch Size (1)
    ├── C: Channels (RGB → 3)
    ├── H: Height (224)
    └── W: Width (224)
    │
    ▼
归一化处理
    │
    ├── Mean: [0.485, 0.456, 0.406]
    └── Std: [0.229, 0.224, 0.225]
    │
    ▼
ONNX 推理
    │
    ▼
Softmax + ArgMax
    │
    ▼
返回分类标签
```

## 6. 模型规格

| 项目 | 值 |
|------|-----|
| 模型 | MobileNetV2-7.onnx |
| 输入名 | data |
| 输出名 | mobilenetv20_output_flatten0_reshape0 |
| 输入维度 | [1, 3, 224, 224] |
| 输出维度 | [1, 1000] |
| 分类数 | 1000 (ImageNet) |

## 7. ONNX Runtime 配置

```go
// 从配置文件读取库路径
cfg := config.GetConfig()
if cfg.ImageConfig.OnnxRuntimeLib != "" {
    ort.SetSharedLibraryPath(cfg.ImageConfig.OnnxRuntimeLib)
}
ort.InitializeEnvironment()
```

### 7.1 不同平台的库路径

| 平台 | 库文件 |
|------|--------|
| Windows | onnxruntime.dll |
| Linux | libonnxruntime.so |
| macOS | libonnxruntime.dylib |

## 8. 依赖关系

```
common/image/
    ├── → config                   (配置)
    ├── → yalue/onnxruntime_go     (ONNX Runtime Go 绑定)
    └── → golang.org/x/image/draw  (图像缩放)
```

## 9. 注意事项

1. **CGO 依赖**: 需要启用 CGO (`CGO_ENABLED=1`)
2. **库文件**: 需要下载对应平台的 ONNX Runtime
3. **资源释放**: 使用后必须调用 `Close()` 释放资源
4. **线程安全**: 单例初始化使用 `sync.Once`
5. **图像格式**: 支持 JPEG、PNG、GIF
