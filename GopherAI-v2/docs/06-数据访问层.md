# 数据访问层 (dao/)

## 1. 模块概述

数据访问层（DAO - Data Access Object）负责与数据库交互，封装所有的数据库操作，为服务层提供数据访问接口。基于 GORM ORM 框架实现。

## 2. 文件结构

```
dao/
├── user/
│   └── user.go       # 用户数据访问
├── session/
│   └── session.go    # 会话数据访问
└── message/
    └── message.go    # 消息数据访问
```

## 3. 用户 DAO (user/user.go)

### 3.1 IsExistUser - 检查用户是否存在（按用户名）

```go
func IsExistUser(username string) (*model.User, bool)
```

**功能**: 通过用户名查询用户是否存在

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| username | string | 用户名（11位数字） |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| user | *model.User | 用户对象（存在时返回） |
| exists | bool | 是否存在 |

**实现**:
```go
func IsExistUser(username string) (*model.User, bool) {
    user, err := mysql.GetUserByUsername(username)
    if err != nil {
        return nil, false
    }
    return user, true
}
```

### 3.2 IsExistUserByEmail - 检查用户是否存在（按邮箱）

```go
func IsExistUserByEmail(email string) (*model.User, bool)
```

**功能**: 通过邮箱查询用户是否存在

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| email | string | 用户邮箱 |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| user | *model.User | 用户对象（存在时返回） |
| exists | bool | 是否存在 |

**实现**:
```go
func IsExistUserByEmail(email string) (*model.User, bool) {
    user, err := mysql.GetUserByEmail(email)
    if err != nil {
        return nil, false
    }
    return user, true
}
```

### 3.3 Register - 注册新用户

```go
func Register(username, email, password string) (*model.User, error)
```

**功能**: 创建新用户记录

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| username | string | 用户名 |
| email | string | 邮箱 |
| password | string | 密码（已加密） |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| user | *model.User | 创建的用户对象 |
| error | error | 错误信息 |

**实现**:
```go
func Register(username, email, password string) (*model.User, error) {
    user := &model.User{
        Username: username,
        Email:    email,
        Password: password,
    }
    
    err := mysql.InsertUser(user)
    if err != nil {
        return nil, err
    }
    
    return user, nil
}
```

## 4. 会话 DAO (session/session.go)

### 4.1 GetSessionsByUserName - 获取用户的所有会话

```go
func GetSessionsByUserName(userName string) ([]model.Session, error)
```

**功能**: 查询指定用户的所有会话列表

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| userName | string | 用户名 |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| sessions | []model.Session | 会话列表 |
| error | error | 错误信息 |

**SQL 等价**:
```sql
SELECT * FROM sessions 
WHERE user_name = ? AND deleted_at IS NULL
ORDER BY created_at DESC
```

**实现**:
```go
func GetSessionsByUserName(userName string) ([]model.Session, error) {
    var sessions []model.Session
    err := mysql.DB.Where("user_name = ?", userName).
        Order("created_at DESC").
        Find(&sessions).Error
    return sessions, err
}
```

### 4.2 CreateSession - 创建新会话

```go
func CreateSession(session *model.Session) error
```

**功能**: 创建新的会话记录

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| session | *model.Session | 会话对象 |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| error | error | 错误信息 |

**实现**:
```go
func CreateSession(session *model.Session) error {
    return mysql.DB.Create(session).Error
}
```

### 4.3 GetSessionByID - 根据 ID 获取会话

```go
func GetSessionByID(sessionID string) (*model.Session, error)
```

**功能**: 通过会话 ID 查询会话详情

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| sessionID | string | 会话 ID (UUID) |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| session | *model.Session | 会话对象 |
| error | error | 错误信息 |

**实现**:
```go
func GetSessionByID(sessionID string) (*model.Session, error) {
    var session model.Session
    err := mysql.DB.Where("id = ?", sessionID).First(&session).Error
    return &session, err
}
```

## 5. 消息 DAO (message/message.go)

### 5.1 GetMessagesBySessionID - 获取会话的所有消息

```go
func GetMessagesBySessionID(sessionID string) ([]model.Message, error)
```

**功能**: 查询指定会话的所有消息

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| sessionID | string | 会话 ID |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| messages | []model.Message | 消息列表 |
| error | error | 错误信息 |

**SQL 等价**:
```sql
SELECT * FROM messages 
WHERE session_id = ?
ORDER BY created_at ASC
```

**实现**:
```go
func GetMessagesBySessionID(sessionID string) ([]model.Message, error) {
    var messages []model.Message
    err := mysql.DB.Where("session_id = ?", sessionID).
        Order("created_at ASC").
        Find(&messages).Error
    return messages, err
}
```

### 5.2 GetMessagesBySessionIDs - 批量获取消息

```go
func GetMessagesBySessionIDs(sessionIDs []string) ([]model.Message, error)
```

**功能**: 批量查询多个会话的消息

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| sessionIDs | []string | 会话 ID 列表 |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| messages | []model.Message | 消息列表 |
| error | error | 错误信息 |

**SQL 等价**:
```sql
SELECT * FROM messages 
WHERE session_id IN (?, ?, ...)
ORDER BY created_at ASC
```

**实现**:
```go
func GetMessagesBySessionIDs(sessionIDs []string) ([]model.Message, error) {
    var messages []model.Message
    err := mysql.DB.Where("session_id IN ?", sessionIDs).
        Order("created_at ASC").
        Find(&messages).Error
    return messages, err
}
```

### 5.3 CreateMessage - 创建新消息

```go
func CreateMessage(message *model.Message) error
```

**功能**: 创建新的消息记录

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| message | *model.Message | 消息对象 |

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| error | error | 错误信息 |

**实现**:
```go
func CreateMessage(message *model.Message) error {
    return mysql.DB.Create(message).Error
}
```

### 5.4 GetAllMessages - 获取所有消息

```go
func GetAllMessages() ([]model.Message, error)
```

**功能**: 获取数据库中的所有消息（启动时加载用）

**返回值**:
| 返回值 | 类型 | 说明 |
|--------|------|------|
| messages | []model.Message | 所有消息列表 |
| error | error | 错误信息 |

**使用场景**: 应用启动时将历史消息加载到 AIHelperManager 内存中

**实现**:
```go
func GetAllMessages() ([]model.Message, error) {
    var messages []model.Message
    err := mysql.DB.Order("created_at ASC").Find(&messages).Error
    return messages, err
}
```

## 6. 数据库操作模式

### 6.1 查询模式

```go
// 单条查询
var user model.User
err := mysql.DB.Where("username = ?", username).First(&user).Error
if errors.Is(err, gorm.ErrRecordNotFound) {
    // 记录不存在
}

// 列表查询
var sessions []model.Session
err := mysql.DB.Where("user_name = ?", userName).
    Order("created_at DESC").
    Find(&sessions).Error

// IN 查询
var messages []model.Message
err := mysql.DB.Where("session_id IN ?", sessionIDs).
    Find(&messages).Error
```

### 6.2 创建模式

```go
// 单条创建
user := &model.User{Username: "xxx", Email: "xxx"}
err := mysql.DB.Create(user).Error

// 批量创建
users := []model.User{{...}, {...}}
err := mysql.DB.Create(&users).Error
```

### 6.3 更新模式

```go
// 更新单个字段
mysql.DB.Model(&user).Update("name", "new_name")

// 更新多个字段
mysql.DB.Model(&user).Updates(map[string]interface{}{
    "name": "new_name",
    "email": "new_email",
})
```

### 6.4 删除模式

```go
// 软删除（设置 deleted_at）
mysql.DB.Delete(&session)

// 硬删除
mysql.DB.Unscoped().Delete(&session)
```

## 7. 数据库表结构

### 7.1 users 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| name | VARCHAR(50) | | 昵称 |
| email | VARCHAR(100) | INDEX | 邮箱 |
| username | VARCHAR(50) | UNIQUE | 用户名 |
| password | VARCHAR(255) | | 密码(MD5) |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |
| deleted_at | DATETIME | INDEX | 删除时间(软删除) |

### 7.2 sessions 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | PRIMARY KEY | 会话ID(UUID) |
| user_name | VARCHAR(50) | INDEX, NOT NULL | 用户名 |
| title | VARCHAR(100) | | 会话标题 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |
| deleted_at | DATETIME | INDEX | 删除时间(软删除) |

### 7.3 messages 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| session_id | VARCHAR(36) | INDEX, NOT NULL | 会话ID(外键) |
| user_name | VARCHAR(20) | | 用户名 |
| content | TEXT | | 消息内容 |
| is_user | TINYINT(1) | NOT NULL | 是否用户消息 |
| created_at | DATETIME | | 创建时间 |

## 8. 依赖关系

```
dao/
├── user/
│   ├── → common/mysql   (数据库连接)
│   └── → model          (User 模型)
│
├── session/
│   ├── → common/mysql   (数据库连接)
│   └── → model          (Session 模型)
│
└── message/
    ├── → common/mysql   (数据库连接)
    └── → model          (Message 模型)
```

## 9. 调用关系图

```
┌─────────────────────────────────────────────────────────────┐
│                       Service Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ user.service │  │session.service│  │message.service│      │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
           │                  │                  │
           ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                         DAO Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   user.dao   │  │  session.dao │  │  message.dao │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
           │                  │                  │
           └──────────────────┼──────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      common/mysql                            │
│                        GORM DB                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         MySQL                                │
└─────────────────────────────────────────────────────────────┘
```

## 10. 注意事项

1. **软删除**: User 和 Session 模型使用 GORM 软删除，查询时自动过滤 `deleted_at IS NOT NULL`
2. **索引优化**: 常用查询字段（username, email, session_id, user_name）已建立索引
3. **错误处理**: 建议检查 `gorm.ErrRecordNotFound` 区分记录不存在和其他错误
4. **批量操作**: 大量数据操作建议使用批量接口减少数据库连接次数
5. **事务支持**: 如需事务，使用 `mysql.DB.Transaction()` 包装
