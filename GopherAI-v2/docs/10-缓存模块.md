# 缓存模块 (common/cache/)

## 1. 模块概述

缓存模块提供统一的缓存接口，支持 Redis 和 BigCache 两种后端，包含消息队列功能用于异步持久化消息。

## 2. 文件结构

```
common/cache/
├── cache.go           # 缓存管理器
└── redis_adapter.go   # Redis 适配器
```

## 3. 核心结构体

### 3.1 CacheManager

```go
type CacheManager struct {
    cacheType CacheType          // redis / bigcache
    bigCache  *bigcache.BigCache // 内存缓存
    mu        sync.RWMutex
    msgQueue  chan []byte        // 内存消息队列
    stopChan  chan struct{}      // 停止信号
}

type CacheType string

const (
    CacheTypeRedis    CacheType = "redis"
    CacheTypeBigCache CacheType = "bigcache"
)
```

### 3.2 消息队列参数

```go
type MessageQueueParam struct {
    SessionID string `json:"session_id"`
    Content   string `json:"content"`
    UserName  string `json:"user_name"`
    IsUser    bool   `json:"is_user"`
}
```

## 4. 主要函数

### 4.1 初始化

```go
// 初始化缓存（自动选择 Redis/BigCache）
func Init() error

// 初始化消息队列
func InitMessageQueue() error

// 启动消息消费者
func StartMessageConsumer()
```

### 4.2 缓存操作

```go
// 设置缓存
func Set(key string, value []byte, expiration time.Duration) error

// 获取缓存
func Get(key string) ([]byte, error)

// 删除缓存
func Delete(key string) error
```

### 4.3 消息队列

```go
// 发布消息到队列
func PublishMessage(data []byte) error

// 生成消息参数
func GenerateMessageParam(sessionID, content, userName string, isUser bool) []byte
```

## 5. 工作流程

### 5.1 初始化流程

```
Init()
    │
    ├── 检查 config.RedisEnabled
    │   ├── true → 尝试连接 Redis
    │   │   ├── 成功 → CacheTypeRedis
    │   │   └── 失败 → 降级 BigCache
    │   │
    │   └── false → 使用 BigCache
    │
    ▼
InitMessageQueue()
    │
    ├── Redis 模式 → 使用 Redis Stream
    │
    └── BigCache 模式 → 创建 channel 队列
    │
    ▼
StartMessageConsumer()
    │
    └── 启动 goroutine 消费消息
```

### 5.2 消息持久化流程

```
AIHelper.AddMessage()
    │
    ▼
cache.GenerateMessageParam()
    │
    ▼
cache.PublishMessage()
    │
    ├── Redis 模式
    │   └── XADD message_queue * data <json>
    │
    └── BigCache 模式
        └── msgQueue <- data
    │
    ▼
消费者 goroutine
    │
    ├── Redis: XREAD BLOCK ...
    │
    └── BigCache: <-msgQueue
    │
    ▼
message.CreateMessage() → MySQL
```

## 6. Redis Stream 操作

```go
// 发布消息
XADD message_queue * data <json_data>

// 消费消息（阻塞读取）
XREAD BLOCK 0 STREAMS message_queue $
```

## 7. BigCache 配置

```go
bigcache.DefaultConfig(10 * time.Minute)
// 默认过期时间: 10 分钟
// 分片数: 1024
// 最大条目大小: 500KB
```

## 8. 依赖关系

```
common/cache/
    ├── → config          (Redis 配置)
    ├── → common/redis    (Redis 客户端)
    ├── → dao/message     (消息持久化)
    ├── → model           (Message 模型)
    └── → allegro/bigcache (内存缓存)
```

## 9. 注意事项

1. **自动降级**: Redis 连接失败自动降级到 BigCache
2. **消息顺序**: 消息队列保证 FIFO 顺序
3. **异步持久化**: 消息通过队列异步写入数据库
4. **优雅关闭**: 应在程序退出时关闭 stopChan
