# 路由模块 (router/)

## 1. 模块概述

路由模块负责定义和注册所有 HTTP API 路由，基于 Gin 框架实现，包含 JWT 认证中间件集成和 CORS 跨域配置。

## 2. 文件结构

```
router/
├── router.go    # 路由总入口，初始化 Gin 引擎
├── AI.go        # AI 聊天相关路由
├── File.go      # 文件上传路由
├── Image.go     # 图像识别路由
└── user.go      # 用户认证路由
```

## 3. 路由总入口 (router.go)

### 3.1 核心函数

```go
func InitRouter() *gin.Engine {
    r := gin.Default()
    
    // CORS 配置
    r.Use(cors.New(cors.Config{
        AllowOrigins:     []string{"*"},
        AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
        AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"},
        ExposeHeaders:    []string{"Content-Length"},
        AllowCredentials: true,
        MaxAge:           12 * time.Hour,
    }))
    
    // API v1 路由组
    v1 := r.Group("/api/v1")
    {
        RegisterUserRouter(v1)  // 用户路由（无需认证）
        
        // 需要 JWT 认证的路由
        v1.Use(jwt.Auth())
        {
            AIRouter(v1)      // AI 聊天路由
            FileRouter(v1)    // 文件路由
            ImageRouter(v1)   // 图像路由
        }
    }
    
    return r
}
```

### 3.2 CORS 配置说明

| 配置项 | 值 | 说明 |
|--------|-----|------|
| AllowOrigins | ["*"] | 允许所有来源跨域 |
| AllowMethods | GET, POST, PUT, DELETE, OPTIONS | 允许的 HTTP 方法 |
| AllowHeaders | Origin, Content-Type, Accept, Authorization | 允许的请求头 |
| ExposeHeaders | Content-Length | 允许前端读取的响应头 |
| AllowCredentials | true | 允许发送 Cookie |
| MaxAge | 12 小时 | 预检请求缓存时间 |

## 4. 用户路由 (user.go)

### 4.1 路由定义

```go
func RegisterUserRouter(r *gin.RouterGroup) {
    userGroup := r.Group("/user")
    {
        userGroup.POST("/register", user.Register)  // 用户注册
        userGroup.POST("/login", user.Login)        // 用户登录
    }
}
```

### 4.2 路由表

| 方法 | 路径 | 处理函数 | 认证 | 说明 |
|------|------|----------|------|------|
| POST | /api/v1/user/register | `user.Register` | 否 | 用户注册 |
| POST | /api/v1/user/login | `user.Login` | 否 | 用户登录 |

## 5. AI 聊天路由 (AI.go)

### 5.1 路由定义

```go
func AIRouter(r *gin.RouterGroup) {
    chatGroup := r.Group("/AI")
    {
        // 会话管理
        chatGroup.GET("/chat/sessions", session.GetUserSessionsByUserName)
        
        // 同步消息
        chatGroup.POST("/chat/send-new-session", session.CreateSessionAndSendMessage)
        chatGroup.POST("/chat/send", session.ChatSend)
        chatGroup.POST("/chat/history", session.ChatHistory)
        
        // 流式消息 (SSE)
        chatGroup.POST("/chat/send-stream-new-session", session.CreateStreamSessionAndSendMessage)
        chatGroup.POST("/chat/send-stream", session.ChatStreamSend)
    }
}
```

### 5.2 路由表

| 方法 | 路径 | 处理函数 | 说明 |
|------|------|----------|------|
| GET | /api/v1/AI/chat/sessions | `session.GetUserSessionsByUserName` | 获取用户所有会话列表 |
| POST | /api/v1/AI/chat/send-new-session | `session.CreateSessionAndSendMessage` | 创建新会话并发送消息（同步） |
| POST | /api/v1/AI/chat/send | `session.ChatSend` | 在已有会话中发送消息（同步） |
| POST | /api/v1/AI/chat/history | `session.ChatHistory` | 获取指定会话的聊天历史 |
| POST | /api/v1/AI/chat/send-stream-new-session | `session.CreateStreamSessionAndSendMessage` | 创建新会话并流式发送消息（SSE） |
| POST | /api/v1/AI/chat/send-stream | `session.ChatStreamSend` | 在已有会话中流式发送消息（SSE） |

## 6. 文件路由 (File.go)

### 6.1 路由定义

```go
func FileRouter(r *gin.RouterGroup) {
    fileGroup := r.Group("/file")
    {
        fileGroup.POST("/upload", file.UploadRagFile)
    }
}
```

### 6.2 路由表

| 方法 | 路径 | 处理函数 | 说明 |
|------|------|----------|------|
| POST | /api/v1/file/upload | `file.UploadRagFile` | 上传 RAG 知识库文件 |

## 7. 图像路由 (Image.go)

### 7.1 路由定义

```go
func ImageRouter(r *gin.RouterGroup) {
    imageGroup := r.Group("/image")
    {
        imageGroup.POST("/recognize", image.RecognizeImage)
    }
}
```

### 7.2 路由表

| 方法 | 路径 | 处理函数 | 说明 |
|------|------|----------|------|
| POST | /api/v1/image/recognize | `image.RecognizeImage` | 图像分类识别 |

## 8. 完整 API 路由表

```
/api/v1
├── /user                           [无需认证]
│   ├── POST /register              用户注册
│   └── POST /login                 用户登录
│
├── /AI                             [需要 JWT 认证]
│   └── /chat
│       ├── GET  /sessions                      获取会话列表
│       ├── POST /send-new-session              创建会话+发送(同步)
│       ├── POST /send                          发送消息(同步)
│       ├── POST /history                       获取聊天历史
│       ├── POST /send-stream-new-session       创建会话+发送(流式)
│       └── POST /send-stream                   发送消息(流式)
│
├── /file                           [需要 JWT 认证]
│   └── POST /upload                上传 RAG 文件
│
└── /image                          [需要 JWT 认证]
    └── POST /recognize             图像识别
```

## 9. 认证流程

```
┌─────────────────────────────────────────────────────────────┐
│                      HTTP 请求进入                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      CORS 中间件                             │
│                  处理跨域预检请求                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      路由匹配                                │
│              /api/v1/user/* → 无需认证                       │
│              /api/v1/AI/* → 需要认证                         │
│              /api/v1/file/* → 需要认证                       │
│              /api/v1/image/* → 需要认证                      │
└─────────────────────────────────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              ▼                           ▼
┌─────────────────────┐       ┌─────────────────────────────┐
│    /user 路由组     │       │      JWT 认证中间件          │
│   直接处理请求       │       │  验证 Authorization Header   │
└─────────────────────┘       │  或 Query 参数中的 Token     │
                              └─────────────────────────────┘
                                          │
                              ┌───────────┴───────────┐
                              │                       │
                              ▼                       ▼
                      ┌──────────────┐       ┌──────────────┐
                      │  Token 有效  │       │  Token 无效  │
                      │  继续处理     │       │  返回 401    │
                      └──────────────┘       └──────────────┘
```

## 10. 依赖关系

- **引入的模块**:
  - `gin-gonic/gin` - Web 框架
  - `gin-contrib/cors` - CORS 中间件
  - `middleware/jwt` - JWT 认证中间件
  - `controller/user` - 用户控制器
  - `controller/session` - 会话控制器
  - `controller/file` - 文件控制器
  - `controller/image` - 图像控制器

## 11. 使用示例

### 11.1 main.go 中初始化

```go
func main() {
    // ... 其他初始化 ...
    
    r := router.InitRouter()
    r.Run(":9090")
}
```

### 11.2 API 请求示例

**用户注册**:
```bash
curl -X POST http://localhost:9090/api/v1/user/register \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"123456"}'
```

**发送 AI 消息**:
```bash
curl -X POST http://localhost:9090/api/v1/AI/chat/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"sessionId":"xxx","question":"你好","modelType":"1"}'
```

**流式响应 (SSE)**:
```bash
curl -X POST http://localhost:9090/api/v1/AI/chat/send-stream \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "Accept: text/event-stream" \
  -d '{"sessionId":"xxx","question":"介绍一下Go语言","modelType":"1"}'
```

## 12. 注意事项

1. **路由顺序**: 用户路由在 JWT 中间件之前注册，无需认证
2. **CORS 配置**: 生产环境建议将 `AllowOrigins` 改为具体的域名列表
3. **流式响应**: `/chat/send-stream*` 路由返回 `text/event-stream` 类型
4. **Token 传递**: 支持 `Authorization: Bearer <token>` 头或 `?token=<token>` 查询参数
