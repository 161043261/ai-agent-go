# 数据库模块 (common/mysql/)

## 1. 模块概述

MySQL 模块负责数据库连接管理和基础 CRUD 操作，基于 GORM ORM 框架实现。

## 2. 文件结构

```
common/mysql/
└── mysql.go    # MySQL 连接管理和操作
```

## 3. 全局变量

```go
var DB *gorm.DB  // 全局数据库连接
```

## 4. 主要函数

### 4.1 InitMysql - 初始化连接

```go
func InitMysql() {
    cfg := config.GetConfig()
    
    dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=%s&parseTime=True&loc=Local",
        cfg.MysqlUser,
        cfg.MysqlPassword,
        cfg.MysqlHost,
        cfg.MysqlPort,
        cfg.MysqlDatabaseName,
        cfg.MysqlCharset,
    )
    
    var err error
    DB, err = gorm.Open(mysql.Open(dsn), &gorm.Config{})
    if err != nil {
        log.Fatal("MySQL connection failed:", err)
    }
    
    // 连接池配置
    sqlDB, _ := DB.DB()
    sqlDB.SetMaxIdleConns(10)           // 最大空闲连接
    sqlDB.SetMaxOpenConns(100)          // 最大打开连接
    sqlDB.SetConnMaxLifetime(time.Hour) // 连接最大生命周期
    
    // 自动迁移表结构
    migration()
}
```

### 4.2 migration - 自动迁移

```go
func migration() {
    DB.AutoMigrate(
        &model.User{},
        &model.Session{},
        &model.Message{},
    )
}
```

### 4.3 用户操作

```go
// 插入用户
func InsertUser(user *model.User) error

// 按用户名查询
func GetUserByUsername(username string) (*model.User, error)

// 按邮箱查询
func GetUserByEmail(email string) (*model.User, error)
```

## 5. 连接池配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| MaxIdleConns | 10 | 最大空闲连接数 |
| MaxOpenConns | 100 | 最大打开连接数 |
| ConnMaxLifetime | 1 hour | 连接最大生命周期 |

## 6. DSN 格式

```
user:password@tcp(host:port)/database?charset=utf8mb4&parseTime=True&loc=Local
```

## 7. 依赖关系

```
common/mysql/
    ├── → config    (数据库配置)
    ├── → model     (数据模型)
    └── → gorm      (ORM 框架)
```

## 8. 注意事项

1. **自动迁移**: 启动时自动创建/更新表结构
2. **连接复用**: 使用连接池提升性能
3. **时区设置**: DSN 中 `loc=Local` 使用本地时区
4. **字符集**: 推荐使用 `utf8mb4` 支持 emoji
