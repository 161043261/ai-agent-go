# GopherAI-v2 项目概述

## 1. 项目简介

GopherAI-v2 是一个基于 Go 语言开发的 AI 聊天服务后端，采用典型的分层架构设计。该项目集成了多种 AI 模型支持（OpenAI、Ollama、RAG、MCP），并提供图像识别功能，是一个功能完整的智能对话系统。

## 2. 核心特性

- **多模型支持**: 支持 OpenAI、Ollama 本地模型、RAG 增强检索、MCP 协议工具调用
- **流式响应**: 支持 SSE (Server-Sent Events) 流式输出
- **RAG 功能**: 支持文档上传、向量化存储与语义检索
- **图像识别**: 基于 ONNX Runtime 的 MobileNetV2 图像分类
- **会话管理**: 完整的用户会话和消息历史管理
- **缓存系统**: Redis/BigCache 双模式缓存，支持自动降级
- **消息队列**: 异步消息持久化，提升响应性能

## 3. 技术栈

| 分类 | 技术 | 说明 |
|------|------|------|
| Web 框架 | Gin | 高性能 HTTP 框架 |
| ORM | GORM | Go 语言 ORM |
| 数据库 | MySQL | 关系型数据库 |
| 缓存 | Redis / BigCache | 分布式/内存缓存 |
| AI 框架 | cloudwego/eino | 字节跳动 AI 应用框架 |
| 向量检索 | Redis Vector Search | 向量相似度搜索 |
| 图像识别 | ONNX Runtime | 跨平台推理引擎 |
| 认证 | JWT | JSON Web Token |

## 4. 项目结构

```
GopherAI-v2/
├── main.go                 # 应用入口
├── config/                 # 配置模块
│   ├── config.go          # 配置结构定义
│   └── config.toml        # 配置文件
├── router/                 # 路由模块
│   ├── router.go          # 路由总入口
│   ├── AI.go              # AI 聊天路由
│   ├── File.go            # 文件上传路由
│   ├── Image.go           # 图像识别路由
│   └── user.go            # 用户认证路由
├── controller/             # 控制器层
│   ├── common.go          # 通用响应结构
│   ├── user/              # 用户控制器
│   ├── session/           # 会话控制器
│   ├── file/              # 文件控制器
│   └── image/             # 图像控制器
├── service/                # 服务层
│   ├── user/              # 用户业务
│   ├── session/           # 会话业务
│   ├── file/              # 文件业务
│   └── image/             # 图像业务
├── dao/                    # 数据访问层
│   ├── user/              # 用户 DAO
│   ├── session/           # 会话 DAO
│   └── message/           # 消息 DAO
├── model/                  # 数据模型
│   ├── user.go            # 用户模型
│   ├── session.go         # 会话模型
│   └── message.go         # 消息模型
├── middleware/             # 中间件
│   └── jwt/               # JWT 认证
├── common/                 # 通用模块
│   ├── aihelper/          # AI 助手核心
│   ├── cache/             # 缓存管理
│   ├── code/              # 状态码定义
│   ├── image/             # 图像识别
│   ├── mcp/               # MCP 协议
│   ├── mysql/             # MySQL 连接
│   ├── rag/               # RAG 实现
│   └── redis/             # Redis 操作
└── utils/                  # 工具函数
    ├── utils.go           # 通用工具
    └── myjwt/             # JWT 工具
```

## 5. 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端 (Frontend)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Gin HTTP Server (main.go)                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Router Layer (router/)                      │
│                     JWT 中间件认证过滤                            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Controller Layer (controller/)                 │
│              请求参数解析 → 业务调用 → 响应封装                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Service Layer (service/)                     │
│                       核心业务逻辑处理                            │
└─────────────────────────────────────────────────────────────────┘
            │               │               │               │
            ▼               ▼               ▼               ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│    DAO        │   │   AIHelper    │   │      RAG      │   │    Image      │
│  数据访问层    │   │   AI模型管理   │   │   向量检索     │   │   图像识别     │
└───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘
            │               │               │
            ▼               ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   MySQL     │  │    Redis    │  │   Cache (Redis/BigCache) │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 启动流程

```
1. 读取配置文件 (config.toml)
       ↓
2. 初始化 MySQL 连接 + 自动迁移表结构
       ↓
3. 从数据库加载历史消息到 AIHelperManager
       ↓
4. 初始化缓存 (优先 Redis，降级 BigCache)
       ↓
5. 初始化消息队列
       ↓
6. 启动消息消费者 (异步持久化)
       ↓
7. 启动 HTTP 服务器
```

## 7. API 概览

| 模块 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户 | POST | /api/v1/user/register | 用户注册 |
| 用户 | POST | /api/v1/user/login | 用户登录 |
| AI | GET | /api/v1/AI/chat/sessions | 获取会话列表 |
| AI | POST | /api/v1/AI/chat/send-new-session | 创建会话并发送消息 |
| AI | POST | /api/v1/AI/chat/send | 在已有会话发送消息 |
| AI | POST | /api/v1/AI/chat/history | 获取聊天历史 |
| AI | POST | /api/v1/AI/chat/send-stream-new-session | 流式创建会话 |
| AI | POST | /api/v1/AI/chat/send-stream | 流式发送消息 |
| 文件 | POST | /api/v1/file/upload | 上传 RAG 文件 |
| 图像 | POST | /api/v1/image/recognize | 图像识别 |

## 8. 数据库模型

```
┌──────────────────┐
│      User        │
├──────────────────┤
│ ID (PK)          │
│ Name             │
│ Email (Index)    │
│ Username (UK)    │
│ Password         │
│ CreatedAt        │
│ UpdatedAt        │
│ DeletedAt        │
└──────────────────┘
         │
         │ 1:N
         ▼
┌──────────────────┐
│     Session      │
├──────────────────┤
│ ID (PK, UUID)    │
│ UserName (Index) │◄──────┐
│ Title            │       │
│ CreatedAt        │       │
│ UpdatedAt        │       │ N:1
│ DeletedAt        │       │
└──────────────────┘       │
         │                 │
         │ 1:N             │
         ▼                 │
┌──────────────────┐       │
│     Message      │       │
├──────────────────┤       │
│ ID (PK)          │       │
│ SessionID (Index)│───────┘
│ UserName         │
│ Content          │
│ IsUser           │
│ CreatedAt        │
└──────────────────┘
```

## 9. 环境要求

- Go 1.21+
- MySQL 5.7+ / 8.0
- Redis 6.0+ (可选，用于向量检索和分布式缓存)
- ONNX Runtime 1.23+ (可选，用于图像识别)

## 10. 快速开始

```bash
# 1. 克隆项目
git clone <repository-url>
cd GopherAI-v2

# 2. 配置环境
cp config/config.toml.example config/config.toml
# 编辑 config.toml 配置数据库等信息

# 3. 安装依赖
go mod tidy

# 4. 运行项目
go run main.go
```

## 11. 文档目录

- [01-项目概述.md](./01-项目概述.md) - 本文档
- [02-配置模块.md](./02-配置模块.md) - 配置管理
- [03-路由模块.md](./03-路由模块.md) - API 路由
- [04-控制器模块.md](./04-控制器模块.md) - 控制器层
- [05-服务层模块.md](./05-服务层模块.md) - 业务逻辑
- [06-数据访问层.md](./06-数据访问层.md) - DAO 层
- [07-数据模型.md](./07-数据模型.md) - 数据库模型
- [08-中间件模块.md](./08-中间件模块.md) - JWT 中间件
- [09-AI助手模块.md](./09-AI助手模块.md) - AI 核心
- [10-缓存模块.md](./10-缓存模块.md) - 缓存管理
- [11-数据库模块.md](./11-数据库模块.md) - MySQL 操作
- [12-RAG模块.md](./12-RAG模块.md) - 向量检索
- [13-MCP模块.md](./13-MCP模块.md) - MCP 协议
- [14-图像识别模块.md](./14-图像识别模块.md) - ONNX 推理
- [15-工具函数.md](./15-工具函数.md) - 工具函数
