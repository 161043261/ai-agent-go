# 中间件模块 (middleware/)

## 1. 模块概述

中间件模块提供 HTTP 请求处理的通用功能，目前包含 JWT 认证中间件。

## 2. 文件结构

```
middleware/
└── jwt/
    └── jwt.go    # JWT 认证中间件
```

## 3. JWT 认证中间件 (jwt/jwt.go)

### 3.1 核心函数

```go
func Auth() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. 获取 Token
        token := c.GetHeader("Authorization")
        if token == "" {
            token = c.Query("token")
        }
        
        // 2. 处理 Bearer 前缀
        if strings.HasPrefix(token, "Bearer ") {
            token = token[7:]
        }
        
        // 3. 验证 Token
        if token == "" {
            c.JSON(http.StatusUnauthorized, controller.Response{
                StatusCode: code.CodeNotLogin,
                StatusMsg:  code.CodeNotLogin.Msg(),
            })
            c.Abort()
            return
        }
        
        // 4. 解析 Token
        claims, err := myjwt.ParseToken(token)
        if err != nil {
            c.JSON(http.StatusUnauthorized, controller.Response{
                StatusCode: code.CodeInvalidToken,
                StatusMsg:  code.CodeInvalidToken.Msg(),
            })
            c.Abort()
            return
        }
        
        // 5. 存储用户信息到 Context
        c.Set("userName", claims.Username)
        c.Set("userID", claims.ID)
        
        c.Next()
    }
}
```

### 3.2 Token 获取方式

| 方式 | 格式 | 示例 |
|------|------|------|
| Header | `Authorization: Bearer <token>` | `Authorization: Bearer eyJhbGci...` |
| Query | `?token=<token>` | `?token=eyJhbGci...` |

### 3.3 认证流程

```
HTTP 请求
    │
    ▼
┌─────────────────────────────┐
│ 从 Header/Query 获取 Token  │
└─────────────────────────────┘
    │
    ├── Token 为空 → 401 CodeNotLogin
    │
    ▼
┌─────────────────────────────┐
│      myjwt.ParseToken()     │
└─────────────────────────────┘
    │
    ├── 解析失败 → 401 CodeInvalidToken
    │
    ▼
┌─────────────────────────────┐
│ c.Set("userName", username) │
│ c.Set("userID", id)         │
└─────────────────────────────┘
    │
    ▼
    c.Next() → 继续处理
```

### 3.4 在控制器中获取用户信息

```go
func SomeHandler(c *gin.Context) {
    userName, _ := c.Get("userName")
    userID, _ := c.Get("userID")
    
    // 使用用户信息...
}
```

## 4. 依赖关系

- `utils/myjwt` - JWT Token 解析
- `common/code` - 状态码定义
- `controller` - 响应结构

## 5. 注意事项

- 不需要认证的路由应在注册 Auth 中间件之前定义
- Token 过期或签名无效都会返回 `CodeInvalidToken`
- Context 中存储的用户名用于后续业务处理
